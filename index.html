<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking Test Landing Page</title>
    
    <!-- Bing UET (Universal Event Tracking) - Loads Before Consent -->
    <script>
        // Initialize UET queue
        window.uetq = window.uetq || [];
        
        // Load UET script immediately (before consent)
        (function(w,d,t,r,u){
            var f,n,i;
            f=function(){
                var o={ti:"97220626", enableAutoSpaTracking: true};
                o.q=w[u];
                w[u]=new UET(o);
                
                // Fire pageLoad event immediately
                w[u].push("pageLoad");
            };
            n=d.createElement(t);
            n.src=r;
            n.async=1;
            n.onload=n.onreadystatechange=function(){
                var s=this.readyState;
                if(!s||s==="loaded"||s==="complete"){
                    f();
                    n.onload=n.onreadystatechange=null;
                }
            };
            i=d.getElementsByTagName(t)[0];
            i.parentNode.insertBefore(n,i);
        })(window,document,"script","//bat.bing.com/bat.js","uetq");
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 60px 40px;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #667eea;
        }

        p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: #666;
        }

        .cta-button {
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: none;
        }

        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            margin-top: 50px;
        }

        .feature {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: transform 0.3s ease;
        }

        .feature:hover {
            transform: translateY(-5px);
        }

        .feature h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .feature p {
            font-size: 0.95rem;
            margin-bottom: 0;
        }

        /* Tracking status indicator */
        .tracking-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            display: none;
        }

        .tracking-status.active {
            display: block;
        }

        /* UET Events Display Section */
        .uet-events-section {
            margin-top: 40px;
            padding: 30px;
            background: #f0f4ff;
            border-radius: 15px;
            border: 2px solid #667eea;
        }

        .uet-events-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .uet-status {
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }

        .uet-status.loading {
            border-left-color: #FF9800;
        }

        .uet-status.error {
            border-left-color: #F44336;
        }

        .events-container {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
        }

        .event-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            font-size: 0.9rem;
        }

        .event-item .event-type {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .event-item .event-time {
            color: #999;
            font-size: 0.85rem;
        }

        .event-item .event-data {
            color: #666;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .no-events {
            text-align: center;
            color: #999;
            padding: 30px;
            font-style: italic;
        }

        /* AI Humor Section */
        .humor-section {
            margin-top: 40px;
            padding: 30px;
            background: #fff5f5;
            border-radius: 15px;
            border: 2px solid #ff6b6b;
        }

        .humor-section h2 {
            color: #ff6b6b;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .humor-section p.subtitle {
            color: #666;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .humor-input-area {
            margin-bottom: 20px;
        }

        .humor-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .humor-textarea:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .humor-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .humor-button {
            padding: 12px 30px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .humor-button:hover:not(:disabled) {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .humor-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .humor-button.secondary {
            background: #6c757d;
        }

        .humor-button.secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .humor-response {
            padding: 20px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
            text-align: left;
            display: none;
        }

        .humor-response.visible {
            display: block;
        }

        .humor-response .response-label {
            font-weight: 600;
            color: #ff6b6b;
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .humor-response .response-text {
            color: #333;
            font-size: 1.05rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .humor-response .response-image {
            margin-top: 20px;
            text-align: center;
        }

        .humor-response .response-image img {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        .humor-response .response-image img:hover {
            transform: scale(1.02);
        }

        .humor-response .image-label {
            font-size: 0.85rem;
            color: #999;
            margin-top: 10px;
            font-style: italic;
        }

        .humor-loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .humor-loading.visible {
            display: block;
        }

        .humor-loading .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .humor-error {
            padding: 15px;
            background: #ffe6e6;
            border-radius: 8px;
            color: #d32f2f;
            display: none;
            margin-top: 15px;
        }

        .humor-error.visible {
            display: block;
        }

        /* Cookie Consent Banner */
        .cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(51, 51, 51, 0.98);
            color: white;
            padding: 20px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            display: none;
            animation: slideUp 0.4s ease-out;
        }

        .cookie-banner.visible {
            display: block;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .cookie-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .cookie-text {
            flex: 1;
            min-width: 300px;
        }

        .cookie-text h3 {
            margin: 0 0 8px 0;
            font-size: 1.2rem;
            color: white;
        }

        .cookie-text p {
            margin: 0;
            font-size: 0.95rem;
            color: #ddd;
            line-height: 1.5;
        }

        .cookie-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .cookie-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cookie-btn.accept {
            background: #4CAF50;
            color: white;
        }

        .cookie-btn.accept:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .cookie-btn.decline {
            background: transparent;
            color: white;
            border: 2px solid white;
        }

        .cookie-btn.decline:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 768px) {
            .cookie-content {
                flex-direction: column;
                text-align: center;
            }
            
            .cookie-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .cookie-btn {
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Welcome to the Best Website Ever</h1>
        
        <!-- AI Humor Section -->
        <div class="humor-section">
            <h2>üòÇ AI Humor Generator</h2>
            <p class="subtitle">Enter any text and get a hilarious AI-powered reinterpretation!</p>
            
            <div class="humor-input-area">
                <textarea 
                    class="humor-textarea" 
                    id="humorInput" 
                    placeholder="Type something here... anything! (e.g., 'I love my job', 'The weather is nice today', 'I'm learning JavaScript')"></textarea>
            </div>

            <div class="humor-buttons">
                <button class="humor-button" id="generateBtn" onclick="generateHumor()">
                    ‚ú® Generate Humor
                </button>
                <button class="humor-button secondary" id="regenerateBtn" onclick="regenerateHumor()" style="display: none;">
                    üîÑ Regenerate
                </button>
            </div>

            <div class="humor-loading" id="humorLoading">
                <div class="spinner"></div>
                <p>AI is cooking up something funny and creating an illustration...</p>
            </div>

            <div class="humor-error" id="humorError"></div>

            <div class="humor-response" id="humorResponse">
                <div class="response-label">AI Says:</div>
                <div class="response-text" id="responseText"></div>
                <div class="response-image" id="responseImage" style="display: none;">
                    <img id="generatedImage" src="" alt="AI Generated Illustration">
                    <div class="image-label">AI-generated illustration</div>
                </div>
            </div>
        </div>

        <!-- UET Events Display Section -->
        <div class="uet-events-section">
            <h2>üîµ Bing UET Tracking Events</h2>
            <div class="uet-status" id="uetStatus">
                <strong>Status:</strong> <span id="uetStatusText">Initializing...</span>
            </div>
            <div class="events-container" id="eventsContainer">
                <div class="no-events">No UET events captured yet. Events will appear here as they are tracked.</div>
            </div>
        </div>
    </div>

    <div class="tracking-status" id="trackingStatus">
        Tracking Active ‚úì
    </div>

    <!-- Cookie Consent Banner -->
    <div class="cookie-banner" id="cookieBanner">
        <div class="cookie-content">
            <div class="cookie-text">
                <h3>üç™ We Value Your Privacy</h3>
                <p>We use cookies and tracking technologies (including Bing UET) to improve your experience, analyze site traffic, and personalize content. By clicking "Accept All", you consent to our use of cookies and tracking.</p>
            </div>
            <div class="cookie-buttons">
                <button class="cookie-btn accept" onclick="acceptCookies()">Accept All</button>
                <button class="cookie-btn decline" onclick="declineCookies()">Decline</button>
            </div>
        </div>
    </div>

    <!-- Tracking API Integration -->
    <script>
        // Cookie Consent Management
        function acceptCookies() {
            localStorage.setItem('cookieConsent', 'granted');
            document.getElementById('cookieBanner').classList.remove('visible');
            
            // Send consent update to UET
            if (window.uetq) {
                window.uetq.push('consent', 'update', {
                    'ad_storage': 'granted'
                });
                addUETEvent('Consent Granted', { timestamp: new Date().toISOString() });
            }
            
            console.log('‚úÖ Cookie consent granted - UET ad_storage set to granted');
        }
        
        function declineCookies() {
            localStorage.setItem('cookieConsent', 'denied');
            document.getElementById('cookieBanner').classList.remove('visible');
            
            // Send consent update to UET
            if (window.uetq) {
                window.uetq.push('consent', 'update', {
                    'ad_storage': 'denied'
                });
                addUETEvent('Consent Denied', { timestamp: new Date().toISOString() });
            }
            
            console.log('‚õî Cookie consent declined - UET ad_storage set to denied');
        }
        
        // Show cookie banner on page load if consent not given
        window.addEventListener('DOMContentLoaded', function() {
            const consent = localStorage.getItem('cookieConsent');
            if (!consent) {
                document.getElementById('cookieBanner').classList.add('visible');
            } else if (consent === 'granted') {
                // Consent already granted, send update to UET
                if (window.uetq) {
                    window.uetq.push('consent', 'update', {
                        'ad_storage': 'granted'
                    });
                }
            } else if (consent === 'denied') {
                // Consent was denied, send update to UET
                if (window.uetq) {
                    window.uetq.push('consent', 'update', {
                        'ad_storage': 'denied'
                    });
                }
            }
        });

        // UET Events Tracking
        const uetEvents = [];
        let uetInitialized = false;

        // Override window.uetq to intercept UET events
        const originalUetq = window.uetq || [];
        window.uetq = new Proxy(originalUetq, {
            get(target, prop) {
                return target[prop];
            },
            set(target, prop, value) {
                target[prop] = value;
                return true;
            }
        });

        // Monitor UET initialization
        const checkUETInit = setInterval(() => {
            if (window.UET && typeof window.UET === 'function') {
                if (!uetInitialized) {
                    uetInitialized = true;
                    addUETEvent('UET Initialized', { timestamp: new Date().toISOString() });
                    updateUETStatus('Ready ‚úì', false);
                    clearInterval(checkUETInit);
                }
            }
        }, 100);

        // Add UET event to display
        function addUETEvent(eventType, data = {}) {
            const event = {
                type: eventType,
                data: data,
                timestamp: new Date().toISOString()
            };
            uetEvents.push(event);
            displayUETEvents();
            console.log('üîµ UET Event:', eventType, data);
        }

        // Display UET events in the UI
        function displayUETEvents() {
            const container = document.getElementById('eventsContainer');
            if (!container) return;

            if (uetEvents.length === 0) {
                container.innerHTML = '<div class="no-events">No UET events captured yet. Events will appear here as they are tracked.</div>';
                return;
            }

            container.innerHTML = uetEvents.map((event, index) => `
                <div class="event-item">
                    <div class="event-type">${event.type}</div>
                    <div class="event-time">${new Date(event.timestamp).toLocaleString()}</div>
                    <div class="event-data">${JSON.stringify(event.data, null, 2)}</div>
                </div>
            `).reverse().join('');
        }

        // Update UET status indicator
        function updateUETStatus(text, isLoading = false) {
            const statusEl = document.getElementById('uetStatus');
            const statusText = document.getElementById('uetStatusText');
            if (statusText) {
                statusText.textContent = text;
            }
            if (statusEl) {
                statusEl.className = 'uet-status';
                if (isLoading) statusEl.classList.add('loading');
            }
        }

        // Track custom UET event
        function trackUETEvent(eventAction, eventCategory, eventLabel, eventValue) {
            if (window.uetq && typeof window.uetq.push === 'function') {
                window.uetq.push('event', eventAction, {
                    'event_category': eventCategory,
                    'event_label': eventLabel,
                    'event_value': eventValue
                });
                addUETEvent(`Custom Event: ${eventAction}`, {
                    category: eventCategory,
                    label: eventLabel,
                    value: eventValue
                });
            } else {
                console.warn('UET not available yet');
            }
        }

        // API Configuration
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:7071/api'  // Local development
            : '/api';  // Production (Azure Static Web Apps)
        
        console.log('Landing page loaded');
        console.log('API URL:', API_BASE_URL);
        
        // Track event to backend API
        async function trackEvent(eventType, data = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}/track`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        eventType: eventType,
                        data: {
                            ...data,
                            url: window.location.href,
                            title: document.title,
                            timestamp: new Date().toISOString()
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Event tracked successfully:', eventType, result.eventId);
                } else {
                    console.error('‚ùå Failed to track event:', result.error);
                }
                
                return result;
            } catch (error) {
                console.error('‚ùå Error tracking event:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Track page view
        async function trackPageView() {
            console.log('üìä Tracking page view...');
            await trackEvent('page_view', {
                referrer: document.referrer,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height
            });
        }
        
        // Track button click
        async function trackButtonClick(buttonName) {
            console.log('üñ±Ô∏è Tracking button click:', buttonName);
            await trackEvent('button_click', {
                buttonName: buttonName,
                buttonId: 'ctaButton'
            });
        }
        
        // Check API health
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const health = await response.json();
                console.log('üíö API Status:', health);
                return health.status === 'healthy';
            } catch (error) {
                console.warn('‚ö†Ô∏è API health check failed:', error.message);
                return false;
            }
        }
        
        // Initialize tracking on page load
        window.addEventListener('DOMContentLoaded', async function() {
            // Check API health
            const apiHealthy = await checkAPIHealth();
            
            // Track page view
            await trackPageView();
            
            // Show tracking status indicator
            const statusEl = document.getElementById('trackingStatus');
            if (statusEl) {
                statusEl.classList.add('active');
                if (!apiHealthy) {
                    statusEl.textContent = 'Tracking Offline ‚ö†Ô∏è';
                    statusEl.style.background = 'rgba(255, 165, 0, 0.8)';
                }
            }
        });

        // Initialize UET status on load
        updateUETStatus('Waiting for UET to load...', true);
        
        // Timeout for UET initialization
        setTimeout(() => {
            if (!uetInitialized) {
                updateUETStatus('UET not detected ‚ö†Ô∏è', false);
                document.getElementById('uetStatus').classList.add('error');
            }
        }, 5000);

        // AI Humor Generator Functions
        let lastUserInput = '';

        async function generateHumor() {
            const input = document.getElementById('humorInput').value.trim();
            const loading = document.getElementById('humorLoading');
            const response = document.getElementById('humorResponse');
            const error = document.getElementById('humorError');
            const generateBtn = document.getElementById('generateBtn');
            const regenerateBtn = document.getElementById('regenerateBtn');

            // Reset displays
            response.classList.remove('visible');
            error.classList.remove('visible');

            // Validate input
            if (!input) {
                error.textContent = 'Please enter some text first!';
                error.classList.add('visible');
                return;
            }

            // Save input for regeneration
            lastUserInput = input;

            // Show loading
            loading.classList.add('visible');
            generateBtn.disabled = true;
            regenerateBtn.style.display = 'none';

            try {
                // Call AI API
                const result = await fetch(`${API_BASE_URL}/humorize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: input })
                });

                const data = await result.json();
                
                console.log('üì¶ Full API response:', data);
                console.log('ü§ñ Used AI:', data.usedAI);

                if (data.success && data.humorousText) {
                    // Show response text with AI indicator
                    const aiIndicator = data.usedAI ? ' ü§ñ' : ' üé≠';
                    const modeText = data.usedAI ? ' (AI-powered)' : ' (Demo mode)';
                    document.getElementById('responseText').textContent = data.humorousText + aiIndicator;
                    console.log('Mode:', data.usedAI ? 'AI-powered' : 'Demo mode with placeholders');
                    
                    // Show image if available
                    const imageContainer = document.getElementById('responseImage');
                    const imageElement = document.getElementById('generatedImage');
                    
                    if (data.imageUrl) {
                        console.log('üñºÔ∏è Setting image URL:', data.imageUrl);
                        
                        // Add error handling for image load
                        imageElement.onerror = function() {
                            console.error('‚ùå Image failed to load:', data.imageUrl);
                            // Try fallback image
                            imageElement.src = 'https://ui-avatars.com/api/?name=AI+Humor&size=1024&background=ff6b6b&color=fff&bold=true&font-size=0.33';
                        };
                        
                        imageElement.onload = function() {
                            console.log('‚úÖ Image loaded successfully');
                        };
                        
                        imageElement.src = data.imageUrl;
                        imageElement.alt = 'AI-generated illustration for: ' + data.humorousText.substring(0, 50);
                        imageContainer.style.display = 'block';
                    } else {
                        console.warn('‚ö†Ô∏è No image URL in response');
                        imageContainer.style.display = 'none';
                    }
                    
                    response.classList.add('visible');
                    regenerateBtn.style.display = 'inline-block';

                    // Track UET event
                    trackUETEvent('humor_generated', 'engagement', 'AI Humor Generator', 1);
                    
                    console.log('üòÇ Humor generated:', data.humorousText);
                } else {
                    throw new Error(data.error || 'Failed to generate humor');
                }
            } catch (err) {
                console.error('Error generating humor:', err);
                error.textContent = err.message || 'Failed to generate humor. Please try again.';
                error.classList.add('visible');
            } finally {
                loading.classList.remove('visible');
                generateBtn.disabled = false;
            }
        }

        async function regenerateHumor() {
            if (lastUserInput) {
                await generateHumor();
            }
        }

        // Allow Enter key to submit (with Shift+Enter for new line)
        document.getElementById('humorInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                generateHumor();
            }
        });
    </script>
</body>
</html>
